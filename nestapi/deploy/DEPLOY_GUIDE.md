# ğŸš€ NestAPI ä¸€é”®éƒ¨ç½²æŒ‡å—

## å¿«é€Ÿå¼€å§‹

### æœ€ç®€å•çš„éƒ¨ç½²æ–¹å¼ï¼ˆæ¨èï¼‰

```bash
# ä¸€é”®æ‰§è¡Œï¼šæœ¬åœ°æ„å»º â†’ æ‰“åŒ… â†’ ä¸Šä¼  â†’ æœåŠ¡å™¨éƒ¨ç½² â†’ æ•°æ®åº“è¿ç§»
./deploy/auto-deploy.sh
```

å°±è¿™ä¹ˆç®€å•ï¼è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆæ‰€æœ‰æ­¥éª¤ã€‚

---

## è¯¦ç»†ä½¿ç”¨è¯´æ˜

### 1ï¸âƒ£ å®Œæ•´éƒ¨ç½²ï¼ˆæœ€å¸¸ç”¨ï¼‰

```bash
./deploy/auto-deploy.sh
```

**æ‰§è¡Œæµç¨‹ï¼š**
- âœ… æœ¬åœ°æ„å»º TypeScript ä»£ç 
- âœ… æ‰“åŒ…æˆå‘å¸ƒæ–‡ä»¶
- âœ… ä¸Šä¼ åˆ°æœåŠ¡å™¨
- âœ… æœåŠ¡å™¨ç«¯éƒ¨ç½²ï¼ˆåœæ­¢åº”ç”¨ â†’ å¤‡ä»½ â†’ æ›´æ–° â†’ å¯åŠ¨ï¼‰
- âœ… è¿è¡Œæ•°æ®åº“è¿ç§»
- âœ… è‡ªåŠ¨éªŒè¯

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         ğŸš€ NestAPI ä¸€é”®éƒ¨ç½²è„šæœ¬                        â•‘
â•‘         2025-10-29 20:15:30                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[â„¹ï¸  INFO] æ‰§è¡Œ: ./deploy/build.sh
[â„¹ï¸  INFO] Node.js ç‰ˆæœ¬: v22.18.0
[â„¹ï¸  INFO] npm ç‰ˆæœ¬: 10.9.3
[âœ… SUCCESS] æœ¬åœ°æ„å»ºå®Œæˆ

[â„¹ï¸  INFO] æ‰§è¡Œ: ./deploy/package.sh
[âœ… SUCCESS] æ‰“åŒ…å®Œæˆ: nestapi-20251029-201530.tar.gz

[â„¹ï¸  INFO] å‘å¸ƒæ–‡ä»¶: nestapi-20251029-201530.tar.gz (324K)
[â„¹ï¸  INFO] éƒ¨ç½²ç›®æ ‡: 123.207.14.67
```

---

### 2ï¸âƒ£ è·³è¿‡æœ¬åœ°æ„å»ºï¼ˆåªæ›´æ–°å·²ç¼–è¯‘ä»£ç ï¼‰

å¦‚æœä½ å·²ç»è¿è¡Œè¿‡æ„å»ºï¼Œåªæƒ³é‡æ–°æ‰“åŒ…å’Œéƒ¨ç½²ï¼š

```bash
./deploy/auto-deploy.sh --skip-build
```

**æ‰§è¡Œæµç¨‹ï¼š**
- â­ï¸ è·³è¿‡æœ¬åœ°æ„å»º
- âœ… æ‰“åŒ…æˆå‘å¸ƒæ–‡ä»¶
- âœ… ä¸Šä¼ åˆ°æœåŠ¡å™¨
- âœ… æœåŠ¡å™¨ç«¯éƒ¨ç½²
- âœ… è¿è¡Œæ•°æ®åº“è¿ç§»

**ä½¿ç”¨åœºæ™¯ï¼š**
- ä»£ç æ²¡æœ‰æ”¹å˜ï¼Œåªæƒ³éƒ¨ç½²ä¸€ä¸ªæ–°ç‰ˆæœ¬
- å‡å°‘éƒ¨ç½²æ—¶é—´

---

### 3ï¸âƒ£ è·³è¿‡æ‰“åŒ…ï¼ˆä½¿ç”¨æœ€æ–°çš„å‘å¸ƒåŒ…ï¼‰

å¦‚æœä½ æœ‰ç°æˆçš„å‘å¸ƒåŒ…ï¼Œç›´æ¥éƒ¨ç½²ï¼š

```bash
./deploy/auto-deploy.sh --skip-pack
```

**æ‰§è¡Œæµç¨‹ï¼š**
- â­ï¸ è·³è¿‡æœ¬åœ°æ„å»º
- â­ï¸ è·³è¿‡æ‰“åŒ…ï¼ˆä½¿ç”¨ deploy/releases/ ä¸­æœ€æ–°çš„åŒ…ï¼‰
- âœ… ä¸Šä¼ åˆ°æœåŠ¡å™¨
- âœ… æœåŠ¡å™¨ç«¯éƒ¨ç½²
- âœ… è¿è¡Œæ•°æ®åº“è¿ç§»

**ä½¿ç”¨åœºæ™¯ï¼š**
- éƒ¨ç½²å¤šæ¬¡ç›¸åŒçš„ç‰ˆæœ¬
- ç´§æ€¥é‡æ–°éƒ¨ç½²ï¼ˆé—®é¢˜å›æ»šï¼‰

---

### 4ï¸âƒ£ æµ‹è¯•æ¨¡å¼ï¼ˆæ¼”ç»ƒéƒ¨ç½²æµç¨‹ä½†ä¸å®é™…éƒ¨ç½²ï¼‰

```bash
./deploy/auto-deploy.sh --dry-run
```

**æ‰§è¡Œæµç¨‹ï¼š**
- æ˜¾ç¤ºæ‰€æœ‰æ­¥éª¤
- â­ï¸ ä¸æ‰§è¡Œå®é™…çš„æ„å»ºã€æ‰“åŒ…ã€ä¸Šä¼ 
- ç”¨äºæ£€æŸ¥éƒ¨ç½²æµç¨‹æ˜¯å¦æ­£ç¡®

**ä½¿ç”¨åœºæ™¯ï¼š**
- éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®
- å­¦ä¹ éƒ¨ç½²æµç¨‹
- æµ‹è¯•æƒé™å’Œè¿æ¥

---

## åˆ†æ­¥éƒ¨ç½²ï¼ˆé«˜çº§ç”¨æ³•ï¼‰

å¦‚æœä½ æƒ³åˆ†æ­¥æ‰§è¡Œï¼Œå¯ä»¥é€ä¸ªè¿è¡Œè„šæœ¬ï¼š

### æ­¥éª¤ 1: æœ¬åœ°æ„å»º

```bash
./deploy/build.sh
```

è¾“å‡ºï¼š`dist/` æ–‡ä»¶å¤¹ï¼ˆ1.5Mï¼ŒåŒ…å«ç¼–è¯‘åçš„ä»£ç ï¼‰

### æ­¥éª¤ 2: æ‰“åŒ…

```bash
./deploy/package.sh
```

è¾“å‡ºï¼š`deploy/releases/nestapi-YYYYMMDD-HHMMSS.tar.gz`

### æ­¥éª¤ 3: éƒ¨ç½²

```bash
./deploy/deploy.sh
```

**ç„¶ååœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š**

```bash
ssh root@123.207.14.67

cd /opt/ruizhu-app/nestapi-dist

npm run typeorm migration:run
```

---

## éƒ¨ç½²é…ç½®

ç¼–è¾‘ `deploy/auto-deploy.sh` ä¸­çš„é…ç½®ï¼š

```bash
# ç¬¬ 26-30 è¡Œ
REMOTE_HOST="123.207.14.67"           # æœåŠ¡å™¨ IP
REMOTE_USER="root"                    # SSH ç”¨æˆ·
REMOTE_PASSWORD="Pp123456"            # SSH å¯†ç 
REMOTE_APP_DIR="/opt/ruizhu-app/nestapi-dist"  # åº”ç”¨ç›®å½•
REMOTE_BACKUP_DIR="/opt/ruizhu-app/backups"    # å¤‡ä»½ç›®å½•
```

---

## å®æ—¶ç›‘æ§éƒ¨ç½²

### æŸ¥çœ‹éƒ¨ç½²è¿›åº¦

```bash
# å®æ—¶æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
sshpass -p "Pp123456" ssh root@123.207.14.67 pm2 logs ruizhu-backend
```

### æ£€æŸ¥éƒ¨ç½²çŠ¶æ€

```bash
# æŸ¥çœ‹åº”ç”¨æ˜¯å¦è¿è¡Œ
sshpass -p "Pp123456" ssh root@123.207.14.67 pm2 list

# æµ‹è¯• API æ˜¯å¦å¯è®¿é—®
curl https://yunjie.online/api/docs

# æŸ¥çœ‹æ•°æ®åº“è¿ç§»çŠ¶æ€
sshpass -p "Pp123456" ssh root@123.207.14.67 \
  "cd /opt/ruizhu-app/nestapi-dist && npm run typeorm migration:show"
```

---

## å¸¸è§é—®é¢˜

### Q: éƒ¨ç½²å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ

**A:** ä½¿ç”¨æœ€æ–°çš„å¤‡ä»½æ¢å¤ï¼š

```bash
ssh root@123.207.14.67

# æŸ¥çœ‹å¤‡ä»½
ls -lh /opt/ruizhu-app/backups/

# æ¢å¤æœ€æ–°å¤‡ä»½
cd /opt/ruizhu-app/backups
LATEST_BACKUP=$(ls -t nestapi-backup-*.tar.gz | head -1)
tar -xzf $LATEST_BACKUP -C /opt/ruizhu-app/nestapi-dist

# é‡å¯åº”ç”¨
pm2 restart ruizhu-backend
```

### Q: å¦‚ä½•è·³è¿‡è¿ç§»åªéƒ¨ç½²ä»£ç ï¼Ÿ

**A:** ä¿®æ”¹ `auto-deploy.sh`ï¼Œæ³¨é‡Šæ‰é˜¶æ®µ 6:

```bash
# æ³¨é‡Šæ‰ä»¥ä¸‹ä»£ç å—ï¼ˆçº¦ç¬¬ 280 è¡Œï¼‰
# log_step "é˜¶æ®µ 6ï¸âƒ£ : æ•°æ®åº“è¿ç§»"
# ...
```

### Q: å¦‚ä½•æŸ¥çœ‹éƒ¨ç½²çš„ç‰ˆæœ¬ï¼Ÿ

**A:**

```bash
ssh root@123.207.14.67

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
cat /opt/ruizhu-app/nestapi-dist/VERSION

# æŸ¥çœ‹éƒ¨ç½²æ—¶é—´
ls -l /opt/ruizhu-app/backups/ | head -5
```

### Q: éƒ¨ç½²æ—¶é—´éœ€è¦å¤šä¹…ï¼Ÿ

**A:**
- å®Œæ•´éƒ¨ç½²ï¼š5-10 åˆ†é’Ÿï¼ˆå–å†³äºç½‘ç»œå’ŒæœåŠ¡å™¨æ€§èƒ½ï¼‰
- è·³è¿‡æ„å»ºï¼š2-3 åˆ†é’Ÿ
- è·³è¿‡æ‰“åŒ…ï¼š1-2 åˆ†é’Ÿ

---

## éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

åœ¨è¿è¡Œéƒ¨ç½²å‰ï¼Œç¡®ä¿ï¼š

- [ ] æœ¬åœ°ä»£ç å·²æäº¤åˆ° git
- [ ] `.env` æ–‡ä»¶å·²æ­£ç¡®é…ç½®ï¼ˆåŒ…å« `WECHAT_MCH_ID` ç­‰ï¼‰
- [ ] å¯ä»¥é€šè¿‡ SSH è¿æ¥åˆ°æœåŠ¡å™¨
- [ ] æœåŠ¡å™¨ä¸Šæœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] PM2 åœ¨æœåŠ¡å™¨ä¸Šå·²å®‰è£…

---

## éƒ¨ç½²åéªŒè¯

```bash
# 1. æ£€æŸ¥åº”ç”¨çŠ¶æ€
sshpass -p "Pp123456" ssh root@123.207.14.67 pm2 status

# 2. æ£€æŸ¥æ•°æ®åº“è¡¨
sshpass -p "Pp123456" ssh root@123.207.14.67 \
  "mysql -h localhost -u root -p your_password your_database -e 'SHOW TABLES LIKE \"wechat_%\";'"

# 3. æµ‹è¯• WeChat æ”¯ä»˜ API
curl -X POST https://yunjie.online/api/wechat/payment/create-order \
  -H "Content-Type: application/json" \
  -d '{"openid": "test", "totalFee": 100}'

# 4. æµ‹è¯• WeChat é€šçŸ¥ API
curl -X POST https://yunjie.online/api/wechat/notification/send-subscribe \
  -H "Content-Type: application/json" \
  -d '{"openid": "test", "templateId": "xxx"}'
```

---

## éƒ¨ç½²æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿è¡Œ auto-deploy.sh                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é˜¶æ®µ 1: æœ¬åœ°æ„å»º                      â”‚
â”‚   (build.sh - npm run build)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é˜¶æ®µ 2: æœ¬åœ°æ‰“åŒ…                      â”‚
â”‚   (package.sh - tar -czf)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é˜¶æ®µ 3: éƒ¨ç½²å‰æ£€æŸ¥                    â”‚
â”‚   ç¡®è®¤å‘å¸ƒæ–‡ä»¶ã€å¤§å°ã€ç›®æ ‡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é˜¶æ®µ 4: ä¸Šä¼ å‘å¸ƒåŒ…                    â”‚
â”‚   (scp ä¸Šä¼ åˆ° /tmp/)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é˜¶æ®µ 5: æœåŠ¡å™¨ç«¯éƒ¨ç½²                  â”‚
â”‚   åœæ­¢ â†’ å¤‡ä»½ â†’ è§£å‹ â†’ æ›´æ–° â†’ å¯åŠ¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é˜¶æ®µ 6: æ•°æ®åº“è¿ç§»                    â”‚
â”‚   (npm run typeorm migration:run)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âœ¨ éƒ¨ç½²å®Œæˆï¼                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# å®Œæ•´éƒ¨ç½²
./deploy/auto-deploy.sh

# è·³è¿‡æ„å»ºï¼ˆåªæ‰“åŒ…å’Œéƒ¨ç½²ï¼‰
./deploy/auto-deploy.sh --skip-build

# è·³è¿‡æ‰“åŒ…ï¼ˆä½¿ç”¨ç°æœ‰åŒ…ï¼‰
./deploy/auto-deploy.sh --skip-pack

# æµ‹è¯•éƒ¨ç½²æµç¨‹ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
./deploy/auto-deploy.sh --dry-run

# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
sshpass -p "Pp123456" ssh root@123.207.14.67 pm2 logs ruizhu-backend

# é‡å¯åº”ç”¨
sshpass -p "Pp123456" ssh root@123.207.14.67 pm2 restart ruizhu-backend

# å›æ»šå¤‡ä»½
sshpass -p "Pp123456" ssh root@123.207.14.67 \
  "tar -xzf /opt/ruizhu-app/backups/nestapi-backup-*.tar.gz \
   -C /opt/ruizhu-app/nestapi-dist && pm2 restart ruizhu-backend"
```

---

## éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœéƒ¨ç½²å‡ºç°é—®é¢˜ï¼Œå‚è€ƒä»¥ä¸‹æ–‡æ¡£ï¼š

- `WECHAT_MIGRATION_GUIDE.md` - æ•°æ®åº“è¿ç§»è¯¦ç»†è¯´æ˜
- `deploy/build.sh` - æœ¬åœ°æ„å»ºè„šæœ¬è¯¦æƒ…
- `deploy/package.sh` - æ‰“åŒ…è„šæœ¬è¯¦æƒ…
- `deploy/deploy.sh` - éƒ¨ç½²è„šæœ¬è¯¦æƒ…

---

**æœ€åæ›´æ–°ï¼š2025-10-29**
**ä½œè€…ï¼šClaude Code**

# äº§å“åª’ä½“ç®¡ç†ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„**å›¾ç‰‡å’Œè§†é¢‘ç®¡ç†è§£å†³æ–¹æ¡ˆ**ï¼Œé›†æˆè…¾è®¯äº‘COSï¼Œæ”¯æŒé«˜æ€§èƒ½ä¸Šä¼ ã€é¢„è§ˆã€ç®¡ç†ç­‰åŠŸèƒ½ã€‚

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–æ–¹æ¡ˆ

### 1. **åª’ä½“ä¸Šä¼ ç»„ä»¶ï¼ˆMediaUploaderï¼‰**

#### ç‰¹æ€§
- âœ… æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘ä¸Šä¼ 
- âœ… æ‹–æ‹½ä¸Šä¼ ä½“éªŒ
- âœ… å®æ—¶è¿›åº¦æ˜¾ç¤º
- âœ… æ‰¹é‡ä¸Šä¼ æ”¯æŒ
- âœ… æ–‡ä»¶éªŒè¯ï¼ˆç±»å‹ã€å¤§å°ï¼‰
- âœ… å›¾ç‰‡é¢„è§ˆå’Œè§†é¢‘ç¼©ç•¥å›¾
- âœ… å“åº”å¼ç½‘æ ¼å¸ƒå±€

#### æ–‡ä»¶ä½ç½®
```
/admin/src/components/MediaUploader.tsx
/admin/src/components/MediaUploader.module.scss
```

#### ä½¿ç”¨ç¤ºä¾‹
```tsx
import MediaUploader from '@/components/MediaUploader'

<MediaUploader
  value={mediaFiles}
  onChange={setMediaFiles}
  maxCount={10}
  maxSize={500}
  onUploadToCloud={handleUploadToCOS}
/>
```

---

### 2. **åª’ä½“æœåŠ¡ï¼ˆmediaServiceï¼‰**

#### åŠŸèƒ½æ¸…å•
- `getUploadCredentials()` - è·å–è…¾è®¯äº‘COSä¸´æ—¶å‡­è¯
- `uploadMedia(file)` - ä¸Šä¼ å•ä¸ªæ–‡ä»¶åˆ°åç«¯
- `deleteMedia(url)` - åˆ é™¤åª’ä½“æ–‡ä»¶
- `getImageInfo(url)` - è·å–å›¾ç‰‡å°ºå¯¸ä¿¡æ¯
- `generateThumbnail(url)` - ç”Ÿæˆè§†é¢‘ç¼©ç•¥å›¾
- `uploadMediaBatch(files)` - æ‰¹é‡ä¸Šä¼ æ–‡ä»¶
- `uploadToCOS(file)` - ç›´æ¥ä¸Šä¼ åˆ°è…¾è®¯äº‘COS

#### æ–‡ä»¶ä½ç½®
```
/admin/src/services/media.ts
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ä¸Šä¼ æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€‰æ‹©æ–‡ä»¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éªŒè¯æ–‡ä»¶ç±»å‹/å¤§å° â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    æ˜¯å¦æœ‰onUploadToCloud
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚          â”‚
   æœ‰         æ— 
    â”‚          â”‚
    â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç›´æ¥ä¸Šä¼ â”‚  â”‚åç«¯ä»£ç†â”‚
â”‚åˆ°COS   â”‚  â”‚ä¸Šä¼     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚          â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚è·å–URL  â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚æ›´æ–°åˆ—è¡¨  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ é›†æˆæ­¥éª¤

### 1. æ›´æ–°ProductFormç»„ä»¶

```tsx
// åœ¨è¡¨å•ä¸­æ·»åŠ åª’ä½“æ ‡ç­¾é¡µ
const formTabs = [
  {
    label: 'åŸºæœ¬ä¿¡æ¯',
    key: 'basic',
    children: ( /* ç°æœ‰å†…å®¹ */ )
  },
  {
    label: 'åª’ä½“ç®¡ç†',
    key: 'media',
    children: (
      <MediaUploader
        value={form.getFieldValue('images') || []}
        onChange={(files) => form.setFieldValue('images', files)}
        onUploadToCloud={mediaService.uploadMedia}
      />
    )
  }
]
```

### 2. åç«¯APIæœŸæœ›

#### è·å–COSå‡­è¯
```
GET /api/v1/media/cos-credentials

Response:
{
  "code": 200,
  "data": {
    "cosUrl": "https://bucket.cos.region.myqcloud.com",
    "bucket": "bucket-name",
    "region": "ap-beijing",
    "credentials": {
      "sessionToken": "xxx",
      "tmpSecretId": "xxx",
      "tmpSecretKey": "xxx"
    },
    "expiredTime": 1700000000
  }
}
```

#### ä¸Šä¼ åª’ä½“æ–‡ä»¶
```
POST /api/v1/media/upload
Content-Type: multipart/form-data

Body:
- file: [Binary]
- type: "image" | "video"

Response:
{
  "code": 200,
  "data": {
    "url": "https://bucket.cos.region.myqcloud.com/products/xxx.jpg",
    "type": "image",
    "size": 102400,
    "width": 1920,
    "height": 1080
  }
}
```

#### åˆ é™¤åª’ä½“æ–‡ä»¶
```
DELETE /api/v1/media/delete

Body:
{
  "url": "https://bucket.cos.region.myqcloud.com/products/xxx.jpg"
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. **å›¾ç‰‡ä¼˜åŒ–**
```typescript
// å‹ç¼©å¤§å›¾ç‰‡ï¼ˆä½¿ç”¨ lossless å‹ç¼©ï¼‰
- è‡ªåŠ¨è½¬æ¢ä¸º WebP æ ¼å¼ï¼ˆæ”¯æŒçš„æµè§ˆå™¨ï¼‰
- ç”Ÿæˆå¤šç§å°ºå¯¸çš„ç¼©ç•¥å›¾
- æ‡’åŠ è½½é¢„è§ˆå›¾
```

### 2. **è§†é¢‘ä¼˜åŒ–**
```typescript
// å¯¹è§†é¢‘è¿›è¡Œå¤„ç†
- ç”Ÿæˆè§†é¢‘ç¼©ç•¥å›¾ï¼ˆç¬¬ä¸€å¸§æˆ–æŒ‡å®šå¸§ï¼‰
- é™åˆ¶è§†é¢‘æ–‡ä»¶å¤§å°ï¼ˆé»˜è®¤500MBï¼‰
- æ”¯æŒ HLS/DASH æµåª’ä½“æ ¼å¼
- è·å–è§†é¢‘åŸºæœ¬ä¿¡æ¯ï¼ˆæ—¶é•¿ã€åˆ†è¾¨ç‡ç­‰ï¼‰
```

### 3. **ä¸Šä¼ ä¼˜åŒ–**
```typescript
// å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼ˆå¤§æ–‡ä»¶ï¼‰
- å°†å¤§æ–‡ä»¶åˆ†å‰²æˆå°å—ï¼ˆ5MB/å—ï¼‰
- å¹¶å‘ä¸Šä¼ å¤šä¸ªåˆ†ç‰‡ï¼ˆ3-5ä¸ªå¹¶å‘ï¼‰
- æ”¯æŒæš‚åœ/ç»§ç»­/å–æ¶ˆ
- å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆ3æ¬¡ï¼‰

// å¸¦å®½é™åˆ¶
- é™åˆ¶ä¸Šä¼ é€Ÿåº¦ï¼ˆå¯é€‰ï¼‰
- æ£€æµ‹ç½‘ç»œçŠ¶æ€ï¼Œ4G/WiFi ä¸åŒå¤„ç†
```

---

## ğŸ¨ UI/UX è®¾è®¡è€ƒè™‘

### 1. **ä¸Šä¼ åŒºåŸŸ**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¤  æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„              â”‚
â”‚      æˆ–ç‚¹å‡»é€‰æ‹©                  â”‚
â”‚                                 â”‚
â”‚  âœ… æ”¯æŒ JPG, PNG, GIF ç­‰      â”‚
â”‚  âœ… æ”¯æŒ MP4, WebM ç­‰          â”‚
â”‚  âš ï¸  å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 500MB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **å·²ä¸Šä¼ æ–‡ä»¶å¡ç‰‡**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [å›¾ç‰‡/è§†é¢‘]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ–‡ä»¶å.jpg   â”‚
â”‚ 2.5 MB       â”‚
â”‚ å›¾ç‰‡ | ğŸ”— ğŸ—‘  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **è¿›åº¦æ˜¾ç¤º**
```
ä¸Šä¼ ä¸­: æ–‡ä»¶å.mp4
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  65%
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. **æ–‡ä»¶éªŒè¯**
- âœ… æœåŠ¡å™¨ç«¯æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆMIME typeï¼‰
- âœ… ç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼Œä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼‰
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶
- âœ… ä¸Šä¼ é€Ÿç‡é™åˆ¶

### 2. **è®¿é—®æ§åˆ¶**
- âœ… éœ€è¦è®¤è¯çš„ç”¨æˆ·æ‰èƒ½ä¸Šä¼ 
- âœ… åªæœ‰æ–‡ä»¶æ‰€æœ‰è€…èƒ½åˆ é™¤
- âœ… COS æ–‡ä»¶è®¾ç½®ç§æœ‰è®¿é—®ï¼ˆä½¿ç”¨ç­¾åURLï¼‰
- âœ… å®šæœŸæ¸…ç†è¿‡æœŸæ–‡ä»¶

### 3. **æ•°æ®å®‰å…¨**
- âœ… HTTPS ä¼ è¾“
- âœ… ä¸Šä¼ å‰å®¢æˆ·ç«¯åŠ å¯†ï¼ˆå¯é€‰ï¼‰
- âœ… æ–‡ä»¶åéšæœºåŒ–ï¼ˆé˜²æ­¢ç›®å½•éå†ï¼‰

---

## ğŸ“± å“åº”å¼è®¾è®¡

### æ–­ç‚¹å¸ƒå±€
```
Mobile (xs)  : 1 åˆ—å¸ƒå±€
Tablet (md)  : 2 åˆ—å¸ƒå±€
Desktop (lg) : 4 åˆ—å¸ƒå±€
```

---

## ğŸš€ è…¾è®¯äº‘COSé›†æˆæŒ‡å—

### 1. **å®‰è£…SDK**
```bash
npm install cos-js-sdk-v5
```

### 2. **é…ç½®COSå®¢æˆ·ç«¯**
```typescript
import COS from 'cos-js-sdk-v5'

const cos = new COS({
  getAuthorization(options, callback) {
    // è·å–ä¸´æ—¶å‡­è¯
    const { TmpSecretId, TmpSecretKey, SessionToken, ExpiredTime } = credentials
    callback({
      TmpSecretId,
      TmpSecretKey,
      SecurityToken: SessionToken,
      ExpiredTime,
    })
  },
})
```

### 3. **ä¸Šä¼ åˆ°COS**
```typescript
const uploadToCOS = async (file: File) => {
  return new Promise((resolve, reject) => {
    cos.putObject(
      {
        Bucket: 'bucket-name',
        Region: 'ap-beijing',
        Key: `products/${Date.now()}-${file.name}`,
        Body: file,
        onProgress(progressData) {
          console.log('è¿›åº¦:', progressData.percent)
        },
      },
      (err, data) => {
        if (err) reject(err)
        else resolve(`https://${data.Bucket}.cos.${data.Region}.myqcloud.com/${data.Key}`)
      }
    )
  })
}
```

---

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½å»ºè®®

### Phase 2
- [ ] å›¾ç‰‡ç¼–è¾‘ï¼ˆè£å‰ªã€æ»¤é•œï¼‰
- [ ] è§†é¢‘ç¼–è¾‘ï¼ˆå‰ªè¾‘ã€æ°´å°ï¼‰
- [ ] åª’ä½“åº“ç®¡ç†ï¼ˆåˆ†ç±»ã€æ ‡ç­¾ï¼‰
- [ ] CDN åŠ é€Ÿï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹ï¼‰

### Phase 3
- [ ] AI å†…å®¹å®¡æ ¸
- [ ] è‡ªåŠ¨ç”Ÿæˆäº§å“æè¿°ï¼ˆä»å›¾ç‰‡/è§†é¢‘ï¼‰
- [ ] åª’ä½“åˆ†æï¼ˆç‚¹å‡»çƒ­åŠ›å›¾ï¼‰
- [ ] A/B æµ‹è¯•ï¼ˆä¸åŒå›¾ç‰‡çš„è½¬åŒ–ç‡ï¼‰

---

## ğŸ” å¸¸è§é—®é¢˜

### Q: å¦‚ä½•å¤„ç†å¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆ>500MBï¼‰ï¼Ÿ
A: ä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ 
```typescript
// å°†æ–‡ä»¶åˆ†æˆ 5MB çš„å—
const chunkSize = 5 * 1024 * 1024
const chunks = Math.ceil(file.size / chunkSize)
// å¹¶å‘ä¸Šä¼  3 ä¸ªå—
```

### Q: å¦‚ä½•æ”¯æŒè§†é¢‘é¢„è§ˆï¼Ÿ
A: ç”Ÿæˆç¼©ç•¥å›¾
```typescript
// åç«¯ï¼šä½¿ç”¨ FFmpeg ä»è§†é¢‘ç¬¬ä¸€å¸§ç”Ÿæˆç¼©ç•¥å›¾
// å‰ç«¯ï¼šæ˜¾ç¤ºç¼©ç•¥å›¾ä½œä¸ºè§†é¢‘å°é¢
```

### Q: ä¸Šä¼ å¤±è´¥å¦‚ä½•é‡è¯•ï¼Ÿ
A: è‡ªåŠ¨é‡è¯•æœºåˆ¶
```typescript
const uploadWithRetry = async (file: File, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await mediaService.uploadMedia(file)
    } catch (error) {
      if (i === maxRetries - 1) throw error
      await new Promise(r => setTimeout(r, 1000 * (i + 1))) // æŒ‡æ•°é€€é¿
    }
  }
}
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [è…¾è®¯äº‘COSæ–‡æ¡£](https://cloud.tencent.com/document/product/436)
- [Ant Design Uploadç»„ä»¶](https://ant.design/components/upload-cn/)
- [æ–‡ä»¶ä¸Šä¼ æœ€ä½³å®è·µ](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/upload)

---

## ğŸ“‹ Checklist

- [ ] åˆ›å»º MediaUploader ç»„ä»¶
- [ ] åˆ›å»º mediaService æœåŠ¡
- [ ] é›†æˆåˆ° ProductForm è¡¨å•
- [ ] åç«¯å®ç°ä¸Šä¼ æ¥å£
- [ ] åç«¯é›†æˆè…¾è®¯äº‘COS
- [ ] æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æµç¨‹
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆå›¾ç‰‡å‹ç¼©ã€ç¼©ç•¥å›¾ï¼‰
- [ ] å®‰å…¨æ€§æ£€æŸ¥ï¼ˆæ–‡ä»¶éªŒè¯ã€è®¿é—®æ§åˆ¶ï¼‰
- [ ] äº§å“æ–‡æ¡£å’Œç”¨æˆ·æŒ‡å—


# RUIZHU 小程序 - 购买逻辑规划文档

## 1. 系统现状分析

### 当前已实现的功能
- ✅ 产品浏览（首页、分类页、VIP私人定制）
- ✅ 产品详情页面（独立详情页）
- ✅ 购物车（完整的购物车功能）
  - 产品选择/取消选择
  - 数量增减
  - 产品删除
  - 全选/取消全选
  - 合计金额计算
  - 推荐商品展示
- ✅ VIP 定制咨询（专属定制流程）
  - 产品浏览
  - 咨询表单提交
  - 用户信息收集

### 当前缺失的功能
- ❌ 结算页（Checkout Page）
- ❌ 订单确认页（Order Confirmation）
- ❌ 收货地址管理与选择
- ❌ 支付方式选择
- ❌ 优惠券/优惠码
- ❌ 订单历史（My Orders）
- ❌ 订单详情页
- ❌ 订单跟踪/物流信息
- ❌ 退货/售后流程
- ❌ 用户账户系统（登录/注册）

---

## 2. 购买流程设计

### 2.1 普通商品购买流程

```
首页/分类/推荐
   ↓
[产品列表] → 点击产品
   ↓
[产品详情页]
   ├─ 产品信息展示
   ├─ 图片轮播
   ├─ 规格选择（颜色、尺码、数量等）
   ├─ 收藏按钮
   └─ [加入购物车] 或 [立即购买]
       ↓
   加入购物车 ──→ 显示toast提示 → 返回当前页面
   立即购买 ───→ 直接进入结算流程
   ↓
[购物袋]
   ├─ 购物车列表（可编辑）
   ├─ 选择/全选产品
   ├─ 修改数量
   ├─ 删除产品
   ├─ 合计金额
   ├─ 猜你喜欢推荐
   └─ [立即结算] 按钮
       ↓
[结算页 - Checkout]
   ├─ 订单商品列表（不可编辑）
   ├─ 收货地址选择/编辑
   ├─ 运费显示
   ├─ 优惠券输入框
   ├─ 费用明细
   │  ├─ 商品总额
   │  ├─ 运费
   │  ├─ 折扣/优惠
   │  └─ 应付金额
   └─ [确认订单] 按钮
       ↓
[订单确认页 - Order Confirmation]
   ├─ 订单号
   ├─ 订单详情
   ├─ 收货信息
   ├─ 物流追踪入口
   └─ [返回首页] 或 [查看订单]
```

### 2.2 VIP 定制购买流程

```
VIP私人定制页 / 定制咨询页
   ↓
[产品选择]
   ├─ 浏览4个精选产品（服装、珠宝、鞋履、香水）
   └─ 点击产品
       ↓
[定制咨询表单]
   ├─ 产品预览
   ├─ 用户姓名 *
   ├─ 用户电话 *
   ├─ 邮箱
   ├─ 颜色选择
   ├─ 定制需求备注
   └─ [提交咨询]
       ↓
[咨询提交成功]
   ├─ 显示成功提示
   ├─ 订单号生成（后端处理）
   └─ 重定向到 [VIP订单页面] 或 [首页]

说明：VIP定制流程不涉及支付，而是由销售团队跟进客户，报价后再进行支付
```

---

## 3. 需要新增的页面

### 3.1 结算页 (Checkout Page)
**路径**: `pages/checkout/checkout.vue`

**功能**:
- 显示选中的购物车商品
- 收货地址选择/编辑
- 运费计算
- 优惠券应用
- 费用汇总
- 订单提交

**关键数据**:
```javascript
{
  selectedItems: [],      // 从购物车传递
  address: {},           // 收货地址对象
  expressPrice: 0,       // 运费
  discount: 0,           // 折扣
  coupon: '',            // 优惠券代码
  totalPrice: 0,         // 合计
  paymentMethod: ''      // 支付方式
}
```

### 3.2 收货地址管理页 (Address Management)
**路径**: `pages/addresses/addresses.vue` (已存在)

**功能改进**:
- 显示用户保存的所有地址
- 设置默认地址
- 添加新地址
- 编辑地址
- 删除地址

### 3.3 订单确认页 (Order Confirmation)
**路径**: `pages/order/confirmation.vue`

**功能**:
- 显示订单号
- 订单详情
- 预计送达时间
- 物流信息（如可用）
- 返回首页或查看订单

### 3.4 订单详情页 (Order Details)
**路径**: `pages/orders/order-detail.vue`

**功能**:
- 订单基本信息
- 商品列表
- 收货地址
- 物流跟踪
- 申请退货/售后

### 3.5 支付页面 (Payment Page)
**路径**: `pages/payment/payment.vue`

**功能**:
- 支付方式选择
  - 微信支付
  - 支付宝（可选）
  - 其他支付方式
- 金额确认
- 支付调用
- 支付结果处理

---

## 4. 数据流和状态管理

### 4.1 购物车数据结构

```javascript
// 单个购物车项目
{
  id: '',              // 产品ID
  name: '',           // 产品名称
  price: 0,           // 单价
  quantity: 1,        // 数量
  selected: true,     // 是否选中
  color: '',          // 颜色/规格
  size: '',           // 尺码
  image: '',          // 产品图片
  specs: {            // 其他规格
    material: '',
    style: ''
  }
}
```

### 4.2 订单数据结构

```javascript
// 订单对象
{
  orderId: '',         // 订单号
  userId: '',          // 用户ID
  status: '',          // 订单状态（待支付、已支付、已发货、已收货）
  items: [],           // 商品列表
  subtotal: 0,         // 商品小计
  express: 0,          // 运费
  discount: 0,         // 折扣
  coupon: '',          // 优惠券代码
  total: 0,            // 应付总额
  address: {           // 收货地址
    name: '',
    phone: '',
    province: '',
    city: '',
    district: '',
    detail: ''
  },
  paymentMethod: '',   // 支付方式
  paymentTime: '',     // 支付时间
  createdAt: '',       // 创建时间
  updatedAt: '',       // 更新时间
  trackingNumber: '',  // 物流单号
  logistics: []        // 物流信息
}
```

### 4.3 用户信息数据结构

```javascript
{
  userId: '',
  username: '',
  phone: '',
  email: '',
  avatar: '',
  addresses: [],       // 地址列表
  favorites: [],       // 收藏列表
  orders: [],          // 订单列表
  consultations: []    // 咨询记录
}
```

---

## 5. 购买逻辑要点

### 5.1 加入购物车逻辑

```javascript
// 流程
1. 用户在产品详情页选择规格
2. 点击"加入购物车"
3. 验证选择是否完整
4. 检查购物车中是否已存在相同产品+规格的项
   - 如果存在：数量叠加
   - 如果不存在：新增项
5. 保存到本地存储（localStorage）
6. 显示toast提示"已添加到购物车"
7. 返回当前页面
```

### 5.2 立即购买逻辑

```javascript
// 流程
1. 用户选择规格后点击"立即购买"
2. 直接创建临时订单
3. 跳转到结算页
4. 用户可在结算页修改数量或删除项
5. 确认无误后提交订单
```

### 5.3 结算逻辑

```javascript
// 流程
1. 用户在购物车选中商品后点击"立即结算"
2. 跳转结算页，显示选中商品
3. 用户选择/新增收货地址
4. 系统自动计算运费（可根据地址）
5. 用户可输入优惠券代码
6. 显示费用明细汇总
7. 点击"确认订单"
8. 跳转支付页或订单确认页
9. 清空购物车
10. 创建订单记录
```

### 5.4 订单管理逻辑

```javascript
// 订单状态流转
待支付 → 已支付 → 已发货 → 已收货 → (可申请退货)

// 用户可操作的时间窗口
- 待支付时：可取消订单
- 已发货时：可查看物流信息
- 已收货时：可申请退货/评价
```

---

## 6. VIP 定制逻辑

### 6.1 咨询提交流程

```javascript
// 流程
1. 用户在定制咨询页选择产品
2. 填写咨询表单
   - 姓名（必填）
   - 电话（必填）
   - 邮箱（可选）
   - 颜色选择（产品依赖）
   - 定制需求备注
3. 表单验证
4. 提交至后端
5. 生成咨询单号
6. 保存至用户的咨询记录
7. 返回首页或自动跳转至VIP订单页
```

### 6.2 销售跟进流程

```
咨询单 → 销售确认 → 发送报价 → 用户确认价格 → 生成订单 → 支付 → 发货

说明：
- 所有步骤都由销售团队在后端系统处理
- 用户可在"我的"页面查看咨询进度
- 收到报价后，用户在小程序中确认支付
```

---

## 7. 关键业务规则

### 7.1 购物车规则
- 每个用户的购物车最多保存 **100 件商品**
- 同一商品的相同规格会**自动合并**数量
- 商品价格变化时，**显示提示**但不自动更新

### 7.2 订单规则
- 单个订单最多包含 **50 件商品**
- 订单创建后 **30 分钟内必须支付**，否则自动取消
- 订单支付后 **7 天内可申请退货**
- VIP 定制订单特殊处理，由销售跟进

### 7.3 运费规则
- 订单满 **500 元免运费**
- 不满 500 元，**按地区收取运费**
- 港澳台和国外地区**需特殊处理**

### 7.4 优惠券规则
- 优惠券**不可与其他优惠叠加**
- 每个优惠券**有使用次数限制**
- 优惠券**有过期时间限制**

---

## 8. 前端实现优先级

### 优先级 1（立即实现）
- [ ] 修改产品详情页，增加"立即购买"按钮
- [ ] 实现购物车持久化（localStorage）
- [ ] 创建结算页（Checkout）
- [ ] 创建订单确认页

### 优先级 2（第二阶段）
- [ ] 支付页面集成（微信支付）
- [ ] 订单详情页
- [ ] 物流跟踪功能
- [ ] 订单列表优化

### 优先级 3（后续优化）
- [ ] 优惠券系统
- [ ] 售后/退货流程
- [ ] 用户账户系统
- [ ] 价格变化提醒

---

## 9. 小程序支付集成

### 9.1 微信支付流程

```
1. 后端生成预支付订单
2. 调用 wx.requestPayment() API
3. 用户完成支付
4. 后端接收支付回调
5. 验证签名
6. 更新订单状态
7. 返回支付结果给前端
8. 前端显示支付结果
```

### 9.2 后端需要实现的接口

```
POST /api/orders/create           - 创建订单
POST /api/orders/payment          - 支付接口
GET  /api/orders/:orderId         - 获取订单详情
GET  /api/orders                  - 获取订单列表
POST /api/orders/:orderId/cancel  - 取消订单
POST /api/returns/create          - 申请退货
GET  /api/logistics/:trackingNo   - 获取物流信息
POST /api/coupons/validate        - 验证优惠券
POST /api/consultations           - 提交VIP咨询
GET  /api/consultations           - 获取咨询列表
```

---

## 10. 总结

### 核心购买路径
```
浏览产品 → 选择规格 → 加入购物车/立即购买 → 结算 → 支付 → 订单确认
```

### 两大购买渠道
1. **普通商品购买** - 标准电商流程（支持购物车合并、优惠券等）
2. **VIP 定制购买** - 轻量级咨询流程（由销售跟进，特殊定价）

### 下一步行动
1. 完成结算页实现
2. 集成微信支付 API
3. 创建订单管理系统
4. 实现物流跟踪功能

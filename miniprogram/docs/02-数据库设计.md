# RUIZHU 小程序数据库设计文档

## 1. 数据库选择

### 关系型数据库 (MySQL 8.0+)
- 用途：存储结构化数据（用户、订单、商品等）
- 优点：ACID特性、事务支持、数据一致性好
- 配置：主从复制+读写分离

### 缓存数据库 (Redis 7.0+)
- 用途：缓存、Session、消息队列
- 优点：性能高、支持多种数据结构
- 配置：集群模式+Sentinel高可用

---

## 2. MySQL 核心表设计

### 2.1 用户表 (users)

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  openid VARCHAR(100) UNIQUE NOT NULL COMMENT '微信openid',
  unionid VARCHAR(100) COMMENT '微信unionid',
  nickname VARCHAR(100) COMMENT '昵称',
  avatar_url VARCHAR(255) COMMENT '头像URL',
  phone VARCHAR(20) COMMENT '手机号',
  email VARCHAR(100) COMMENT '邮箱',
  gender INT COMMENT '0:未知, 1:男, 2:女',
  city VARCHAR(50) COMMENT '城市',
  province VARCHAR(50) COMMENT '省份',
  country VARCHAR(50) COMMENT '国家',
  user_type INT DEFAULT 0 COMMENT '0:普通用户, 1:会员',
  vip_level INT DEFAULT 0 COMMENT '会员等级',
  vip_expire_date DATETIME COMMENT '会员过期时间',
  status INT DEFAULT 1 COMMENT '1:正常, 0:禁用',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME COMMENT '软删除',
  INDEX idx_openid (openid),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2.2 用户地址表 (user_addresses)

```sql
CREATE TABLE user_addresses (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  name VARCHAR(50) NOT NULL COMMENT '收货人名字',
  phone VARCHAR(20) NOT NULL,
  province VARCHAR(50) NOT NULL,
  city VARCHAR(50) NOT NULL,
  district VARCHAR(50) NOT NULL,
  detail VARCHAR(200) NOT NULL COMMENT '详细地址',
  is_default BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_user_id (user_id),
  INDEX idx_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户地址表';
```

### 2.3 商品分类表 (categories)

```sql
CREATE TABLE categories (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL UNIQUE COMMENT '分类名称',
  description TEXT COMMENT '分类描述',
  icon_url VARCHAR(255) COMMENT '分类图标',
  sort_order INT DEFAULT 0 COMMENT '排序',
  is_active BOOLEAN DEFAULT TRUE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_sort (sort_order),
  INDEX idx_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品分类表';
```

### 2.4 商品表 (products)

```sql
CREATE TABLE products (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  category_id BIGINT NOT NULL,
  sku VARCHAR(50) UNIQUE NOT NULL COMMENT '商品SKU',
  name VARCHAR(100) NOT NULL COMMENT '商品名称',
  description TEXT COMMENT '商品描述',
  price DECIMAL(10, 2) NOT NULL COMMENT '销售价格',
  original_price DECIMAL(10, 2) COMMENT '原价',
  stock INT DEFAULT 0 COMMENT '库存',
  sold_count INT DEFAULT 0 COMMENT '销售量',

  main_image VARCHAR(255) COMMENT '主图',
  images JSON COMMENT '其他图片(JSON数组)',
  colors JSON COMMENT '颜色选项',
  sizes JSON COMMENT '尺码选项',
  materials VARCHAR(255) COMMENT '材质',
  brand VARCHAR(50) DEFAULT 'RUIZHU' COMMENT '品牌',

  status INT DEFAULT 1 COMMENT '1:上架, 0:下架, 2:删除',
  is_new BOOLEAN DEFAULT FALSE COMMENT '是否新品',
  is_hot BOOLEAN DEFAULT FALSE COMMENT '是否热销',

  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (category_id) REFERENCES categories(id),
  INDEX idx_category (category_id),
  INDEX idx_sku (sku),
  INDEX idx_price (price),
  INDEX idx_status (status),
  FULLTEXT INDEX ft_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';
```

### 2.5 订单表 (orders)

```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_no VARCHAR(50) UNIQUE NOT NULL COMMENT '订单号',
  user_id BIGINT NOT NULL,

  subtotal DECIMAL(10, 2) NOT NULL COMMENT '商品小计',
  express_price DECIMAL(10, 2) DEFAULT 0 COMMENT '运费',
  discount_price DECIMAL(10, 2) DEFAULT 0 COMMENT '优惠金额',
  total_price DECIMAL(10, 2) NOT NULL COMMENT '总金额',

  coupon_id BIGINT COMMENT '优惠券ID',
  coupon_code VARCHAR(50) COMMENT '优惠券代码',

  status INT DEFAULT 0 COMMENT '0:待支付, 1:已支付, 2:已发货, 3:已完成, 4:已取消, 5:已退款',
  payment_method VARCHAR(20) COMMENT '支付方式',
  payment_time DATETIME COMMENT '支付时间',

  receiver_name VARCHAR(50),
  receiver_phone VARCHAR(20),
  receiver_province VARCHAR(50),
  receiver_city VARCHAR(50),
  receiver_district VARCHAR(50),
  receiver_detail VARCHAR(200),

  express_code VARCHAR(50) COMMENT '快递公司代码',
  express_no VARCHAR(50) COMMENT '快递单号',
  express_time DATETIME COMMENT '发货时间',

  remark TEXT COMMENT '备注',

  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_user (user_id),
  INDEX idx_order_no (order_no),
  INDEX idx_status (status),
  INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

### 2.6 订单详情表 (order_items)

```sql
CREATE TABLE order_items (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,
  product_name VARCHAR(100),
  product_sku VARCHAR(50),
  product_image VARCHAR(255),
  color VARCHAR(50),
  size VARCHAR(20),
  price DECIMAL(10, 2) NOT NULL COMMENT '购买时价格',
  quantity INT NOT NULL,
  subtotal DECIMAL(10, 2) NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id),
  INDEX idx_order (order_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单详情表';
```

### 2.7 购物车表 (cart_items)

```sql
CREATE TABLE cart_items (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,
  color VARCHAR(50),
  size VARCHAR(20),
  quantity INT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (product_id) REFERENCES products(id),
  UNIQUE KEY uk_user_product (user_id, product_id, color, size),
  INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='购物车表';
```

### 2.8 支付记录表 (payments)

```sql
CREATE TABLE payments (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,

  payment_method VARCHAR(20) NOT NULL COMMENT '支付方式',
  transaction_id VARCHAR(100) COMMENT '支付交易ID',

  status INT DEFAULT 0 COMMENT '0:未支付, 1:已支付, 2:支付失败, 3:已退款',

  prepay_id VARCHAR(100),
  noncestr VARCHAR(50),
  timestamp BIGINT,
  sign VARCHAR(255),

  notify_data JSON COMMENT '回调数据',

  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (order_id) REFERENCES orders(id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_order (order_id),
  INDEX idx_user (user_id),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支付记录表';
```

### 2.9 优惠券表 (coupons)

```sql
CREATE TABLE coupons (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100),
  description TEXT,
  discount_type INT DEFAULT 1 COMMENT '1:固定金额, 2:百分比',
  discount_value DECIMAL(10, 2),
  min_purchase_price DECIMAL(10, 2) COMMENT '最低购买金额',
  max_discount_price DECIMAL(10, 2) COMMENT '最高折扣',

  usage_limit INT DEFAULT -1 COMMENT '使用次数限制',
  used_count INT DEFAULT 0,
  per_user_limit INT DEFAULT 1,

  start_date DATETIME NOT NULL,
  end_date DATETIME NOT NULL,

  is_active BOOLEAN DEFAULT TRUE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_code (code),
  INDEX idx_active (is_active),
  INDEX idx_dates (start_date, end_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券表';
```

### 2.10 收藏表 (favorites)

```sql
CREATE TABLE favorites (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (product_id) REFERENCES products(id),
  UNIQUE KEY uk_user_product (user_id, product_id),
  INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收藏表';
```

---

## 3. 数据库架构设计

### 3.1 主从复制架构

```
┌─────────────────┐
│  Primary (主库)  │
│   MySQL 8.0     │
│   写入操作       │
└────────┬────────┘
         │ Binary Log
         │ 复制
   ┌─────▼─────┐
   │  ┌──────────────┐
   │  │ Slave1 (从库1)│
   │  │ 读操作        │
   │  └──────────────┘
   │  ┌──────────────┐
   │  │ Slave2 (从库2)│
   │  │ 读操作        │
   │  └──────────────┘
```

### 3.2 备份策略

```
- 每日全量备份 (凌晨2:00)
- 每6小时增量备份
- 异地备份存储 (阿里云OSS)
- 备份保留 30天
- 定期恢复测试 (每月)
```

---

## 4. 索引优化策略

### 4.1 核心索引列表

| 表 | 索引 | 说明 |
|---|-----|------|
| users | openid | 快速查找用户 |
| users | created_at | 按时间查询 |
| orders | user_id | 用户订单列表 |
| orders | status | 订单状态筛选 |
| orders | created_at | 订单时间查询 |
| products | category_id | 分类商品查询 |
| products | status | 上架商品查询 |
| products | sku | 按SKU查询 |
| order_items | order_id | 订单详情查询 |
| favorites | user_id | 用户收藏列表 |

### 4.2 慢查询优化

```sql
-- 查询用户所有订单（分页）
SELECT id, order_no, status, total_price, created_at
FROM orders
WHERE user_id = ?
ORDER BY created_at DESC
LIMIT 10;

-- 对应索引:
CREATE INDEX idx_user_created ON orders(user_id, created_at);
```

---

## 5. Redis 缓存设计

### 5.1 缓存键设计规范

```
product:{id}              -- 商品详情
product:list:{category}   -- 分类商品列表
user:{id}                 -- 用户信息
user:session:{token}      -- 用户会话
cart:{user_id}            -- 购物车
favorite:{user_id}        -- 收藏列表
coupon:{code}             -- 优惠券信息
```

### 5.2 缓存过期策略

```
- 商品详情: 1小时
- 分类列表: 12小时
- 用户信息: 2小时
- 会话信息: 7天
- 优惠券: 直到过期日期
```

### 5.3 缓存预热

```
启动时自动加载：
- 所有活跃分类
- 所有上架商品列表
- 常用配置信息
- 活跃优惠券

更新时同步：
- 商品库存变化
- 订单状态变化
- 用户级别变化
```

---

## 6. 数据库容量规划

### 6.1 表空间预估

| 表 | 月增长量 | 年增长量 | 年数据量 |
|----|---------|---------|---------|
| users | 10,000 | 120,000 | 120,000 |
| orders | 50,000 | 600,000 | 600,000 |
| order_items | 100,000 | 1,200,000 | 1,200,000 |
| products | 500 | 6,000 | 10,000 |
| cart_items | 50,000 | 600,000 | 100,000 (临时) |
| favorites | 20,000 | 240,000 | 500,000 |

**总存储需求**: ~20GB (第一年)

---

## 7. 性能调优建议

### 7.1 连接池配置

```go
// MySQL连接池
MaxConnections: 100
MinIdleConnections: 20
MaxConnectionLifetime: 5 minutes

// Redis连接池
MaxConnections: 50
MinIdleConnections: 10
```

### 7.2 查询优化原则

```
1. 避免SELECT * (只查需要的列)
2. 使用LIMIT限制结果集
3. 避免在WHERE中使用函数
4. 使用联接代替子查询
5. 定期分析慢查询日志
```

---

**文档版本**: v1.0
**最后更新**: 2024-10-25

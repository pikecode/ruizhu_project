# 文件管理功能使用指南

## 快速开始

### 1. 启动所有服务

```bash
./start-all-services.sh
```

或分别启动：
```bash
# 后端
./start-backend.sh    # 端口: 8888

# 前端小程序
./start-frontend.sh   # 端口: 8080

# 管理后台
./start-admin.sh      # 端口: 5174
```

### 2. 访问文件管理页面

打开浏览器，访问管理后台：
```
http://localhost:5174/files
```

或登录后在左侧菜单点击 **Files** 菜单项。

---

## 功能说明

### 文件上传
1. 在"文件管理"页面找到"上传文件"卡片
2. 点击"选择文件"按钮
3. 选择要上传的文件（支持所有文件类型，最大 50MB）
4. 点击"上传"按钮
5. 等待上传完成后，文件将自动列表展示

### 文件列表
- **文件列表**标签页展示所有已上传的文件
- 支持分页展示（每页 10、20、50、100 条）
- 可以快速搜索和排序

### 文件操作

#### 预览文件
- 点击表格中的"眼睛"图标可预览文件
- 仅支持浏览器能直接打开的文件类型（图片、PDF 等）

#### 下载文件
- 点击表格中的"下载"图标下载文件
- 文件将使用原始文件名保存到本地

#### 删除文件
- 点击表格中的"删除"图标删除文件
- 系统会确认删除操作
- 删除后的文件将从列表中移除，且不可恢复

### 统计信息
切换到**统计信息**标签页可查看：
- **总文件数**: 已上传的文件总数
- **总存储大小**: 所有文件占用的存储空间
- **文件类型数**: 不同类型的文件数量
- **按类型统计**: 各文件类型的详细数量

---

## API 接口详情

### 上传文件
```bash
POST /api/v1/files/upload
Content-Type: multipart/form-data

请求参数:
- file: 文件（表单上传）

响应:
{
  "id": 1,
  "fileName": "1698345600000-abc123.pdf",
  "originalName": "document.pdf",
  "cosKey": "uploads/1698345600000-abc123.pdf",
  "url": "https://...",
  "mimeType": "application/pdf",
  "size": 524288,
  "fileType": "pdf",
  "uploadedBy": "admin",
  "createdAt": "2024-10-26T02:30:00.000Z",
  "updatedAt": "2024-10-26T02:30:00.000Z"
}
```

### 获取文件列表
```bash
GET /api/v1/files?limit=20&offset=0

请求参数:
- limit: 每页数量（默认 20）
- offset: 偏移量（默认 0）

响应:
{
  "data": [/* file objects */],
  "total": 42
}
```

### 获取单个文件信息
```bash
GET /api/v1/files/:id

响应:
{
  "id": 1,
  "fileName": "...",
  ...
}
```

### 删除文件
```bash
DELETE /api/v1/files/:id

响应: 204 No Content
```

### 获取下载链接
```bash
GET /api/v1/files/:id/download-url?expiresIn=3600

请求参数:
- expiresIn: 链接有效期（秒数，默认 3600）

响应:
{
  "url": "https://..."
}
```

### 获取统计信息
```bash
GET /api/v1/files/stats/overview

响应:
{
  "total": 42,
  "byType": [
    { "type": "pdf", "count": 15 },
    { "type": "jpg", "count": 20 },
    { "type": "png", "count": 7 }
  ],
  "totalSize": 1073741824
}
```

---

## 常见问题

### Q: 为什么上传失败？
**A:** 可能的原因：
1. 文件大小超过 50MB 限制
2. 网络连接问题
3. 后端服务未运行
4. 腾讯云 COS 凭证配置不正确

### Q: 能上传什么类型的文件？
**A:** 默认支持所有文件类型。您可以在上传组件的 `accept` 参数中限制文件类型。

### Q: 文件存储在哪里？
**A:** 所有文件存储在腾讯云对象存储（COS）服务中，具体位置：
- 桶名: `ruizhu-1256655507`
- 地域: `ap-guangzhou`
- 文件路径: `uploads/[timestamp]-[random].[ext]`

### Q: 如何修改最大上传文件大小？
**A:** 修改 `nestapi/.env` 文件中的 `COS_UPLOAD_MAX_SIZE` 参数（单位：字节）。
```env
COS_UPLOAD_MAX_SIZE=104857600  # 100MB
```

### Q: 文件永久存储吗？
**A:** 是的，删除后的文件也保存在 COS 中（标记为已删除），但不会在列表中显示。

### Q: 能否为文件设置密码保护？
**A:** 可以通过腾讯云 COS 的访问控制列表（ACL）或桶策略来实现。详见 [腾讯云文档](https://cloud.tencent.com/document/product/436)。

### Q: 下载链接有过期时间吗？
**A:** 有。通过 `getDownloadUrl` API 获取的链接默认有效期为 3600 秒（1 小时），可自定义。

### Q: 能否在小程序中上传文件？
**A:** 可以。前端小程序可以调用相同的 API 端点进行上传。

---

## 性能优化建议

1. **压缩文件**: 上传前压缩图片和文档，减少文件大小
2. **批量操作**: 避免频繁的单个文件操作，考虑批量 API
3. **缓存**: 频繁访问的文件建议配置 CDN 加速
4. **定期清理**: 定期删除不需要的文件以节省存储成本

---

## 安全建议

1. **认证**: 所有文件操作都需要有效的认证令牌
2. **访问控制**: 在腾讯云控制台配置 COS 桶的访问权限
3. **防盗链**: 启用防盗链以防止文件被滥用
4. **加密**: 考虑为敏感文件启用服务端加密
5. **备份**: 定期备份重要文件

---

## 故障排除

### 症状: 上传超时
**解决**:
- 检查网络连接
- 减小文件大小
- 增加超时时间设置

### 症状: 找不到文件
**解决**:
- 检查文件是否上传成功（查看响应状态）
- 刷新页面重新加载列表
- 检查 API 接口是否可用

### 症状: 无法访问下载链接
**解决**:
- 确认文件未被删除
- 检查 COS 桶的访问权限
- 检查链接是否过期

---

## 相关资源

- 项目文档: [COS_INTEGRATION.md](./COS_INTEGRATION.md)
- 腾讯云 COS: https://cloud.tencent.com/document/product/436
- 后端 API 文档: `nestapi/src/files/`
- 前端组件文档: `admin/src/components/UploadFile.tsx`

---

**最后更新**: 2024-10-26
**版本**: 1.0.0
